<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Arabic Ligature Trainer â€“ HTMLæ•™æ</title>
  <style>
    :root {
      --bg: #0b1220;
      --panel: #121a2b;
      --ink: #eaf2ff;
      --muted: #a9b5d0;
      --brand: #6fb1ff;
      --accent: #84ffcf;
      --danger: #ff8aa1;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; padding: 24px; color: var(--ink); background: radial-gradient(1200px 800px at 20% -10%, #14203a, var(--bg));
      font: 16px/1.6 system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans JP", Arial, sans-serif;
    }
    h1 { font-size: 28px; margin: 0 0 8px; letter-spacing: .3px; }
    .sub { color: var(--muted); margin-bottom: 24px; }

    .tabs { display: grid; grid-template-columns: 220px 1fr; gap: 16px; align-items: start; }
    .menu {
      position: sticky; top: 16px; display: flex; flex-direction: column; gap: 8px;
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,0));
      border: 1px solid rgba(255,255,255,.08); border-radius: 16px; padding: 10px;
    }
    .menu button {
      appearance: none; border: 0; text-align: left; padding: 10px 12px; border-radius: 12px; cursor: pointer;
      background: transparent; color: var(--ink);
    }
    .menu button.active { background: rgba(111,177,255,.14); outline: 1px solid rgba(111,177,255,.45); }

    .panel {
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border: 1px solid rgba(255,255,255,.08); border-radius: 18px; padding: 18px; box-shadow: 0 10px 30px rgba(0,0,0,.3);
    }
    .panel h2 { margin: 4px 0 12px; font-size: 22px; }
    .panel p { color: var(--muted); }

    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)); gap: 10px; margin-top: 12px; }
    .card { background: rgba(255,255,255,.03); border: 1px solid rgba(255,255,255,.08); border-radius: 14px; padding: 10px; }
    .badge { font-size: 12px; color: var(--muted); }

    .arabic {
      font-size: 40px; line-height: 1.4; text-align: center; direction: rtl; unicode-bidi: bidi-override;
      font-family: "Noto Naskh Arabic", "Amiri", "Scheherazade", "Segoe UI", Arial, system-ui, sans-serif;
    }
    .arabic.small { font-size: 28px; }

    .samples { display: grid; grid-template-columns: repeat(4, minmax(120px, 1fr)); gap: 6px; margin-top: 8px; }
    .samples .chunk { padding: 8px; border-radius: 12px; background: rgba(255,255,255,.04); border: 1px solid rgba(255,255,255,.08); }
    .samples .label { display: block; font-size: 12px; color: var(--muted); margin-bottom: 6px; text-align: center; }

    .row { display: flex; gap: 8px; align-items: center; }
    input[type="text"], textarea, select {
      width: 100%; background: rgba(255,255,255,.05); border: 1px solid rgba(255,255,255,.12); color: var(--ink);
      padding: 10px 12px; border-radius: 12px; outline: none;
    }
    .btn {
      appearance: none; border: 0; background: linear-gradient(180deg, rgba(111,177,255,.9), rgba(111,177,255,.6));
      color: #0b1529; font-weight: 700; padding: 10px 14px; border-radius: 12px; cursor: pointer; box-shadow: 0 6px 16px rgba(111,177,255,.3);
    }
    .btn.ghost { background: rgba(255,255,255,.06); color: var(--ink); box-shadow: none; border: 1px solid rgba(255,255,255,.1); }

    .pill { padding: 2px 8px; border-radius: 999px; font-size: 12px; background: rgba(132,255,207,.12); color: var(--accent); border: 1px solid rgba(132,255,207,.4); }

    .decompose { display: grid; gap: 8px; margin-top: 10px; }
    .glyph { display: inline-flex; flex-direction: column; align-items: center; gap: 3px; margin: 6px; padding: 6px 8px; border-radius: 8px; border: 1px dashed rgba(255,255,255,.2); }
    .glyph .code { font-size: 12px; color: var(--muted); }

    .helper { font-size: 13px; color: var(--muted); }
    .hl-break { color: var(--danger); }

    .quiz { display: grid; gap: 12px; grid-template-columns: 1fr; align-items: start; }
    .quiz .question { text-align: center; font-size: 56px; direction: rtl; unicode-bidi: bidi-override; margin-top: 6px; }
    .choices { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 8px; }
    .choices button { padding: 10px; border-radius: 12px; border: 1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.04); color: var(--ink); cursor: pointer; }
    .choices button.correct { outline: 2px solid rgba(132,255,207,.6); }
    .choices button.wrong { outline: 2px solid rgba(255,138,161,.7); }

    .spot { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; align-items: center; margin-top: 6px; }
    .spot .big { font-size: 64px; direction: rtl; unicode-bidi: bidi-override; text-align: center; }
    .spot .explain { color: var(--muted); }

    footer { margin-top: 28px; color: var(--muted); font-size: 13px; }
  </style>
</head>
<body>
  <h1>Arabic Ligature Trainer</h1>
  <div class="sub">ã‚¢ãƒ©ãƒ“ã‚¢æ–‡å­—ã®é€£çµï¼ˆligatureï¼‰ã§å½¢ãŒå¤‰ã‚ã‚‹ä»•çµ„ã¿ã‚’ã€è¦–è¦šçš„ã«ãƒ»å¯¾è©±çš„ã«å­¦ã¹ã‚‹HTMLæ•™æã§ã™ã€‚å„ã‚¿ãƒ–ã§ã€Œå­—å½¢ã®4å½¢ã€ã€Œåˆ†è§£è¡¨ç¤ºã€ã€Œã‚¯ã‚¤ã‚ºã€ã€Œç‰¹æ®Šåˆå­—ã€ã‚’ç·´ç¿’ã§ãã¾ã™ã€‚</div>

  <div class="tabs">
    <nav class="menu" aria-label="Sections">
      <button class="active" data-tab="alphabet">â‘  ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆ & é€£çµ</button>
      <button data-tab="type">â‘¡ å…¥åŠ›ã—ã¦åˆ†è§£</button>
      <button data-tab="quiz">â‘¢ å½¢å½“ã¦ã‚¯ã‚¤ã‚º</button>
      <button data-tab="ligature">â‘£ åˆå­—ã‚¹ãƒãƒƒãƒˆãƒ©ã‚¤ãƒˆ</button>
    </nav>

    <section id="alphabet" class="panel" role="region" aria-labelledby="alphabet-title">
      <h2 id="alphabet-title">ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆ & é€£çµï¼ˆ4ã¤ã®å­—å½¢ / Four contextual formsï¼‰</h2>
      <p>
        ã‚¢ãƒ©ãƒ“ã‚¢æ–‡å­—ã¯å‰å¾Œã®æ–‡å­—ã¨ã® <strong>é€£çµå¯å¦ / Joining behavior</strong> ã«ã‚ˆã‚Šã€
        <span class="pill">å­¤ç«‹å½¢ / Isolated</span>ãƒ»
        <span class="pill">èªé ­å½¢ / Initial</span>ãƒ»
        <span class="pill">èªä¸­å½¢ / Medial</span>ãƒ»
        <span class="pill">èªæœ«å½¢ / Final</span> ã«å¤‰åŒ–ã—ã¾ã™ã€‚ä¸‹ã®ä¸€è¦§ã‹ã‚‰æ–‡å­—ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€4å½¢ã¨é€£çµã‚¿ã‚¤ãƒ—ï¼ˆ<em>ä¸¡é€£çµ / Dual-joining</em>ãƒ»<em>å³é€£çµã®ã¿ / Right-joining only</em>ï¼‰ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
      </p>
      <div class="grid" id="letterGrid" aria-live="polite"></div>
      <div id="letterDetail" class="card" style="margin-top:12px; display:none"></div>
    </section>

    <section id="type" class="panel" style="display:none" role="region" aria-labelledby="type-title">
      <h2 id="type-title">å…¥åŠ›ã—ã¦åˆ†è§£ï¼ˆå¢ƒç•Œã‚’â€œè¦‹ãˆã‚‹åŒ–â€ / Decompose & visualize joinsï¼‰</h2>
      <p>ã‚¢ãƒ©ãƒ“ã‚¢èªã®å˜èªã‚’å…¥åŠ›ã™ã‚‹ã¨ã€é€šå¸¸è¡¨ç¤ºã¨ <strong>åˆ†è§£è¡¨ç¤º / Decomposed</strong>ï¼ˆ1æ–‡å­—ãšã¤ã®æ ãƒ»U+ã‚³ãƒ¼ãƒ‰ãƒ»é€£çµã‚¿ã‚¤ãƒ—ï¼‰ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚é€£çµãŒ<strong>åˆ‡ã‚Œã‚‹ä½ç½® / Break points</strong>ã¯ <span class="hl-break">èµ¤</span> ã§ç¤ºã—ã¾ã™ã€‚</p>
      <div class="row" style="flex-wrap:wrap">
        <input id="arabicInput" type="text" placeholder="ã“ã“ã«ã‚¢ãƒ©ãƒ“ã‚¢èªã‚’å…¥åŠ›ï¼ˆä¾‹: Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø£Ùˆ ÙƒØªØ§Ø¨ï¼‰" aria-label="Arabic input" />
        <button class="btn" id="speakBtn" title="èª­ã¿ä¸Šã’">ğŸ”Š èª­ã¿ä¸Šã’</button>
        <button class="btn ghost" id="spellBtn" title="1æ–‡å­—ãšã¤èª­ã‚€">ğŸ”  ä¸€æ–‡å­—ãšã¤</button>
        <button class="btn ghost" id="repeatHardBtn" title="é›£èª­ç®‡æ‰€ï¼ˆèªä¸­å½¢ï¼‰ã‚’ç¹°ã‚Šè¿”ã™">ğŸ¯ é›£èª­ç®‡æ‰€ãƒªãƒ”ãƒ¼ãƒˆ</button>
      </div>
      <div class="row" style="flex-wrap:wrap">
        <select id="voiceSelect" aria-label="Voice select" style="max-width:280px"></select>
        <label class="helper">é€Ÿåº¦ / Rate <input type="range" id="rateRange" min="0.4" max="1.4" step="0.05" value="0.9"/></label>
        <label class="helper">é«˜ã• / Pitch <input type="range" id="pitchRange" min="0.6" max="1.4" step="0.05" value="1.0"/></label>
      </div>
      <div class="decompose">
        <div><div class="badge">é€šå¸¸è¡¨ç¤º / Normal</div><div id="renderNormal" class="arabic"></div></div>
        <div>
          <div class="badge">åˆ†è§£è¡¨ç¤ºï¼ˆ1å­—ã”ã¨ï¼‰ / Decomposed</div>
          <div id="renderBoxes" class="arabic small" style="text-align:left; direction:ltr"></div>
          <div class="helper" id="joinReport"></div>
        </div>
      </div>
    </section>

    <section id="quiz" class="panel" style="display:none" role="region" aria-labelledby="quiz-title">
      <h2 id="quiz-title">å½¢å½“ã¦ã‚¯ã‚¤ã‚ºï¼ˆèªé ­ãƒ»èªä¸­ãƒ»èªæœ« / Initial Â· Medial Â· Finalï¼‰</h2>
      <p>è¡¨ç¤ºã•ã‚ŒãŸ <strong>é€£çµä¸­ã®å½¢</strong> ãŒã€ã©ã®åŸºæœ¬æ–‡å­—ã«å¯¾å¿œã™ã‚‹ã‹å½“ã¦ã¦ãã ã•ã„ã€‚ç·´ç¿’ã«æœ€é©ãª <em>ä¸¡é€£çµ / Dual-joining</em> ã®æ–‡å­—ã‹ã‚‰å‡ºé¡Œã—ã¾ã™ã€‚</p>
      <div class="quiz">
        <div class="badge">å•é¡Œ / Question</div>
        <div id="quizQ" class="question">Ù€Ù€Ø¨Ù€Ù€</div>
        <div class="choices" id="quizChoices"></div>
        <div class="row">
          <button class="btn" id="nextQuiz">æ¬¡ã®å•é¡Œ / Next</button>
          <div id="quizInfo" class="helper"></div>
        </div>
      </div>
    </section>

    <section id="ligature" class="panel" style="display:none" role="region" aria-labelledby="ligature-title">
      <h2 id="ligature-title">åˆå­—ã‚¹ãƒãƒƒãƒˆãƒ©ã‚¤ãƒˆï¼šÙ„Ø§ï¼ˆãƒ©ãƒ¼ãƒ +ã‚¢ãƒªãƒ•ï¼‰ / Ligature Spotlight: Ù„Ø§ (lam + alif)</h2>
      <div class="spot">
        <div>
          <div class="badge">åˆå­— / Ligature</div>
          <div class="big">Ù„Ø§</div>
        </div>
        <div class="explain">
          <p><strong>Ù„</strong>ï¼ˆLÄmï¼‰ã¨ <strong>Ø§</strong>ï¼ˆAlifï¼‰ãŒç¶šãã¨ã€ã—ã°ã—ã° 1 æ–‡å­—ã®ã‚ˆã†ãªåˆå­— <strong>Ù„Ø§</strong> ã¨ã—ã¦çµ„ã¾ã‚Œã¾ã™ï¼ˆè¦‹ãŸç›®ã¯1å­—ã§ã‚‚ <em>å®Ÿéš›ã¯2æ–‡å­—</em>ï¼‰ã€‚</p>
          <div class="arabic small" style="text-align:center">Ù„ + Ø§ â†’ Ù„Ø§</div>
          <p>è‹±èªè¡¨è¨˜ / English: <em>lamâ€“alif ligature</em>. åˆ†è§£è¡¨ç¤ºã§ <strong>å¢ƒç•Œ / boundary</strong> ã‚’ç¢ºèªã—ã¾ã—ã‚‡ã†ã€‚</p>
        </div>
      </div>
    </section>
  </div>

  <footer>
    Tips: éé€£çµï¼ˆå·¦ã«ç¹‹ãŒã‚‰ãªã„ï¼‰æ–‡å­— / right-joining only: <span class="arabic small" title="å³é€£çµã®ã¿ / Right-joining only">Ø§ Ø¯ Ø° Ø± Ø² Ùˆ</span>ã€‚ã“ã‚Œã‚‰ã®ç›´å¾Œã§é€£çµãŒåˆ‡ã‚Œã¾ã™ / break occurs right after these.
  </footer>

  <script>
   // === ãƒ‡ãƒ¼ã‚¿å®šç¾© ===
   const RIGHT_JOIN_ONLY = new Set(["Ø§","Ø¯","Ø°","Ø±","Ø²","Ùˆ"]); // å·¦å´ã«é€£çµã—ãªã„ / Right-joining only
   const LETTERS = [
       {ch:"Ø§", name:"Alif"}, {ch:"Ø¨", name:"Ba"}, {ch:"Øª", name:"Ta"}, {ch:"Ø«", name:"Tha"},
       {ch:"Ø¬", name:"Jim"}, {ch:"Ø­", name:"Ha"}, {ch:"Ø®", name:"Kha"}, {ch:"Ø¯", name:"Dal"},
       {ch:"Ø°", name:"Dhal"}, {ch:"Ø±", name:"Ra"}, {ch:"Ø²", name:"Zay"}, {ch:"Ø³", name:"Sin"},
       {ch:"Ø´", name:"Shin"}, {ch:"Øµ", name:"Sad"}, {ch:"Ø¶", name:"Dad"}, {ch:"Ø·", name:"Ta (emph.)"},
       {ch:"Ø¸", name:"Za (emph.)"}, {ch:"Ø¹", name:"Ayn"}, {ch:"Øº", name:"Ghayn"}, {ch:"Ù", name:"Fa"},
       {ch:"Ù‚", name:"Qaf"}, {ch:"Ùƒ", name:"Kaf"}, {ch:"Ù„", name:"Lam"}, {ch:"Ù…", name:"Mim"},
       {ch:"Ù†", name:"Nun"}, {ch:"Ù‡", name:"Ha (Heh)"}, {ch:"Ùˆ", name:"Waw"}, {ch:"ÙŠ", name:"Ya"},
   ];
   function joinType(ch){ return RIGHT_JOIN_ONLY.has(ch) ? "å³é€£çµã®ã¿ / Right-joining only" : "ä¸¡é€£çµ / Dual-joining"; }

   // é€£çµã‚µãƒ³ãƒ—ãƒ«ç”Ÿæˆï¼ˆå®Ÿéš›ã®ã‚¿ãƒˆã‚¦ã‚£ãƒ¼ãƒ«æ–‡å­—ã‚’ä½¿ç”¨ï¼‰
   const TATWEEL = "Ù€";
   function samples(ch){
       const isRightOnly = RIGHT_JOIN_ONLY.has(ch);
       return {
           iso: ch,
           ini: ch + TATWEEL, // èªé ­ / Initial
               med: isRightOnly ? ch : TATWEEL + ch + TATWEEL, // èªä¸­ / Medial
               fin: TATWEEL + ch, // èªæœ« / Final
               note: isRightOnly ? "â€» ã“ã®æ–‡å­—ã¯å·¦å´ã«é€£çµã—ã¾ã›ã‚“ / does not join to the following letter (left)" : ""
       };
   }

   // === UI: ã‚¿ãƒ– ===
   const tabs = document.querySelectorAll('.menu button');
   const sections = {
       alphabet: document.getElementById('alphabet'),
       type: document.getElementById('type'),
       quiz: document.getElementById('quiz'),
       ligature: document.getElementById('ligature'),
   };
   tabs.forEach(b=>b.addEventListener('click',()=>{
       tabs.forEach(x=>x.classList.remove('active'));
       b.classList.add('active');
       const key = b.dataset.tab;
       Object.entries(sections).forEach(([k,el])=> el.style.display = (k===key? 'block':'none'));
   }));

   // === ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆä¸€è¦§ ===
   const grid = document.getElementById('letterGrid');
   const detail = document.getElementById('letterDetail');
   function renderGrid(){
       grid.innerHTML = '';
       LETTERS.forEach((L)=>{
           const card = document.createElement('button');
           card.className = 'card'; card.style.cursor='pointer';
           card.innerHTML = `
          <div class="badge">${L.name}</div>
          <div class="arabic">${L.ch}</div>
           `;
           card.addEventListener('click', ()=> showDetail(L));
           grid.appendChild(card);
       });
   }
   function showDetail(L){
       const s = samples(L.ch);
       detail.style.display='block';
       detail.innerHTML = `
        <div class="row" style="justify-content:space-between; align-items:flex-end">
          <div>
            <div class="badge">é¸æŠä¸­ / Selected</div>
            <div class="arabic">${L.ch}</div>
          </div>
          <div class="helper">åç§° / Name: <strong>${L.name}</strong> ï¼ é€£çµã‚¿ã‚¤ãƒ— / Joining type: <strong>${joinType(L.ch)}</strong></div>
        </div>
        ${s.note? `<div class="helper" style="margin-top:6px">${s.note}</div>`: ''}
        <div class="samples">
          <div class="chunk"><span class="label">å­¤ç«‹å½¢ / Isolated</span><div class="arabic">${s.iso}</div></div>
          <div class="chunk"><span class="label">èªé ­å½¢ / Initial</span><div class="arabic">${s.ini}</div></div>
          <div class="chunk"><span class="label">èªä¸­å½¢ / Medial</span><div class="arabic">${s.med}</div></div>
          <div class="chunk"><span class="label">èªæœ«å½¢ / Final</span><div class="arabic">${s.fin}</div></div>
        </div>
        `;
   }
   renderGrid();

   // === å…¥åŠ›ã—ã¦åˆ†è§£ ===
   const input = document.getElementById('arabicInput');
   const normal = document.getElementById('renderNormal');
   const boxes = document.getElementById('renderBoxes');
   const joinReport = document.getElementById('joinReport');

   const NAME_BY_CHAR = Object.fromEntries(LETTERS.map(L=>[L.ch, L.name]));
   function toCode(u){ return 'U+' + u.codePointAt(0).toString(16).toUpperCase().padStart(4,'0'); }

   function analyze(str){
       const chars = Array.from(str);
       normal.textContent = str;

       boxes.innerHTML = '';
       const breaks = [];
       for (let i=0; i<chars.length; i++){
           const ch = chars[i];
           const span = document.createElement('span');
           span.className = 'glyph';
           span.innerHTML = `<div class="arabic small" style="margin:0;">${ch === ' ' ? 'â ' : ch}</div><div class="code">${ch === ' ' ? 'SPACE' : toCode(ch)} ${NAME_BY_CHAR[ch] ? '('+NAME_BY_CHAR[ch]+')':''}</div>`;
           boxes.appendChild(span);

           if (ch === ' ') { breaks.push(i); continue; }
           const next = chars[i+1];
           const thisRightOnly = RIGHT_JOIN_ONLY.has(ch);
           const nextExists = !!next && next !== ' ';
           const nextJoinableRight = nextExists && !RIGHT_JOIN_ONLY.has(next);
           const willJoin = !thisRightOnly && nextJoinableRight;
           if (!willJoin && nextExists){ breaks.push(i); }
       }
       // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆï¼ˆé€£çµãŒåˆ‡ã‚Œãªã„é€£ç¶šé ˜åŸŸï¼‰ã¨èªä¸­ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®æ¨å®š
       const segments = [];
       let start = 0;
       if (chars.length > 0){
           for (const b of breaks){
               segments.push([start, b]);
               start = b + 1;
           }
           if (start <= chars.length - 1){
               segments.push([start, chars.length - 1]);
           }
       }
       const medialIndicesGlobal = [];
       for (const [s,e] of segments){
           const len = e - s + 1;
           if (len >= 3){
               for (let j = 1; j <= len - 2; j++){
                   const idx = s + j;
                   const ch = chars[idx];
                   if (ch !== ' ' && !RIGHT_JOIN_ONLY.has(ch)){
                       medialIndicesGlobal.push(idx);
                   }
               }
           }
       }
       window.__lastAnalysis = {chars, breaks, segments, medialIndicesGlobal};

       if (chars.length === 0){ joinReport.textContent = ''; return; }
       if (breaks.length){
           joinReport.innerHTML = 'é€£çµãŒåˆ‡ã‚Œã‚‹ä½ç½® / Break points: <span class="hl-break">' + breaks.map(i=> (i+1)).join(', ') + '</span>ï¼ˆå·¦ã‹ã‚‰æ•°ãˆãŸã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ / 1-basedï¼‰ ï¼ é›£èª­ç®‡æ‰€ï¼ˆèªä¸­å½¢å€™è£œï¼‰/ Hard medial candidates: ' + medialIndicesGlobal.length + ' æ–‡å­— / chars';
       } else {
           joinReport.textContent = 'ã™ã¹ã¦é€£çµï¼ˆæ¨å®šï¼‰ / All joined (estimated) ï¼ é›£èª­ç®‡æ‰€ï¼ˆèªä¸­å½¢å€™è£œï¼‰/ Hard medial candidates: ' + medialIndicesGlobal.length + ' æ–‡å­— / chars';
       }
   }
   input.addEventListener('input', e=> analyze(e.target.value));

   // èª­ã¿ä¸Šã’ï¼ˆWeb Speechï¼‰æ‹¡å¼µï¼šãƒœã‚¤ã‚¹é¸æŠãƒ»é€Ÿåº¦/é«˜ã•ãƒ»1æ–‡å­—ãšã¤ãƒ»é›£èª­ç®‡æ‰€
   const speakBtn = document.getElementById('speakBtn');
   const spellBtn = document.getElementById('spellBtn');
   const repeatHardBtn = document.getElementById('repeatHardBtn');
   const voiceSelect = document.getElementById('voiceSelect');
   const rateRange = document.getElementById('rateRange');
   const pitchRange = document.getElementById('pitchRange');

   let voiceList = [];
   function loadVoices(){
       const all = window.speechSynthesis.getVoices();
       const ar = all.filter(v => v.lang && v.lang.toLowerCase().startsWith('ar'));
       const other = all.filter(v => !v.lang || !v.lang.toLowerCase().startsWith('ar'));
       voiceList = [...ar, ...other];
       voiceSelect.innerHTML = voiceList.map((v,i)=>`<option value="${i}">${v.name} (${v.lang||'unknown'})</option>`).join('');
       const idx = voiceList.findIndex(v => v.lang && v.lang.toLowerCase().startsWith('ar'));
       voiceSelect.selectedIndex = idx >= 0 ? idx : 0;
   }
   window.speechSynthesis.onvoiceschanged = loadVoices;
   if (window.speechSynthesis.getVoices().length) loadVoices();

   function speak(text){
       if(!text) return;
       const u = new SpeechSynthesisUtterance(text);
       u.lang = 'ar';
       const v = voiceList[voiceSelect.selectedIndex];
       if (v) u.voice = v;
       u.rate = parseFloat(rateRange.value)||1;
       u.pitch = parseFloat(pitchRange.value)||1;
       window.speechSynthesis.cancel();
       window.speechSynthesis.speak(u);
   }

   speakBtn.addEventListener('click', ()=>{
       const text = input.value.trim();
       speak(text);
   });

   spellBtn.addEventListener('click', ()=>{
       const text = input.value.trim();
       if (!text) return;
       const chars = Array.from(text).filter(c => c.trim() !== '');
       window.speechSynthesis.cancel();
       let delay = 0;
       const v = voiceList[voiceSelect.selectedIndex] || null;
       for (const ch of chars){
           const u = new SpeechSynthesisUtterance(ch);
           u.lang = 'ar';
           if (v) u.voice = v;
           u.rate = Math.max(0.4, (parseFloat(rateRange.value)||1) * 0.9);
           u.pitch = parseFloat(pitchRange.value)||1;
           setTimeout(()=> window.speechSynthesis.speak(u), delay);
           delay += 350;
       }
   });

   repeatHardBtn.addEventListener('click', ()=>{
       const A = window.__lastAnalysis;
       if (!A || !A.medialIndicesGlobal || !A.medialIndicesGlobal.length){
           return spellBtn.click();
       }
       window.speechSynthesis.cancel();
       let delay = 0;
       const v = voiceList[voiceSelect.selectedIndex] || null;
       for (const idx of A.medialIndicesGlobal){
           const ch = A.chars[idx];
           const u = new SpeechSynthesisUtterance(ch);
           u.lang = 'ar';
           if (v) u.voice = v;
           u.rate = Math.max(0.4, (parseFloat(rateRange.value)||1) * 0.9);
           u.pitch = parseFloat(pitchRange.value)||1;
           setTimeout(()=> window.speechSynthesis.speak(u), delay);
           delay += 380;
       }
   });

   // åˆæœŸä¾‹
   input.value = 'Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø¬Ù…ÙŠÙ„Ø©';
   analyze(input.value);

   // === ã‚¯ã‚¤ã‚º ===
   const DUAL = LETTERS.filter(L=> !RIGHT_JOIN_ONLY.has(L.ch));
   const quizQ = document.getElementById('quizQ');
   const quizChoices = document.getElementById('quizChoices');
   const quizInfo = document.getElementById('quizInfo');
   const nextQuiz = document.getElementById('nextQuiz');

   function pick(n, exclude){
       const pool = DUAL.filter(L=> L !== exclude);
       const arr = [];
       while (arr.length < n && pool.length){
           const i = Math.floor(Math.random()*pool.length);
           arr.push(pool.splice(i,1)[0]);
       }
       return arr;
   }

   function makeMedialForm(ch){ return TATWEEL + ch + TATWEEL; }
   function makeInitialForm(ch){ return ch + TATWEEL; }
   function makeFinalForm(ch){ return TATWEEL + ch; }

   function newQuiz(){
       quizInfo.textContent = '';
       quizChoices.innerHTML = '';
       const correct = DUAL[Math.floor(Math.random()*DUAL.length)];
       const mode = ['med','ini','fin'][Math.floor(Math.random()*3)];
       const shape = mode==='med'? makeMedialForm(correct.ch) : mode==='ini'? makeInitialForm(correct.ch) : makeFinalForm(correct.ch);
       quizQ.textContent = shape;
       const distractors = pick(3, correct);
       const options = [correct, ...distractors].sort(()=> Math.random()-0.5);
       options.forEach(opt=>{
           const b = document.createElement('button');
           b.textContent = opt.name + ' ' + opt.ch;
           b.addEventListener('click', ()=>{
               if (opt===correct){ b.classList.add('correct'); quizInfo.textContent = 'æ­£è§£ï¼ / Correct!'; }
               else { b.classList.add('wrong'); quizInfo.textContent = `ä¸æ­£è§£â€¦ / Wrong. æ­£è§£ / Answer: ${correct.name} ${correct.ch}`; }
           });
           quizChoices.appendChild(b);
       });
   }
   nextQuiz.addEventListener('click', newQuiz);
   newQuiz();
  </script>
</body>
</html>
